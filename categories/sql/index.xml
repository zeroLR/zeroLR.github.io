<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>SQL on Zero's Blog</title><link>https://blog.zerolr.net/categories/sql/</link><description>Recent content in SQL on Zero's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sat, 22 Oct 2022 17:57:01 +0000</lastBuildDate><atom:link href="https://blog.zerolr.net/categories/sql/index.xml" rel="self" type="application/rss+xml"/><item><title>ã€PostgreSQLã€‘åˆæ¢ Transaction Isolation</title><link>https://blog.zerolr.net/p/2022/10/22/first-try-transaction-isolation/</link><pubDate>Sat, 22 Oct 2022 17:57:01 +0000</pubDate><guid>https://blog.zerolr.net/p/2022/10/22/first-try-transaction-isolation/</guid><description>&lt;img src="https://blog.zerolr.net/assets/images/pg.jpeg" alt="Featured image of post ã€PostgreSQLã€‘åˆæ¢ Transaction Isolation" />&lt;blockquote>
&lt;p>æœ€è¿‘é¢è©¦è¢«å•åˆ°æœ‰é—œ &lt;strong>Transaction&lt;/strong> çš„å•é¡Œæ™‚ï¼Œå¹¾ä¹ç­”ä¸å‡ºä¾†Orzï¼Œè¶•ç·ŠæŸ¥è³‡æ–™ä¾†å£“å£“é©šã€‚&lt;/p>
&lt;/blockquote>
&lt;p>é€™ç¯‡æˆ‘æœƒå¾å®˜æ–¹æ–‡ä»¶åŠç¶²è·¯æ–‡ç« æ“·å–éƒ¨åˆ†å…§å®¹ï¼Œè©¦è‘—ç†è§£ &lt;a class="link" href="https://www.postgresql.org/docs/14/transaction-iso.html" target="_blank" rel="noopener"
>Postgres ä¸­çš„ Transaction&lt;/a> ï¼Œç”¨ Docker å»ºç«‹ Postgres ä¾†åšå¯¦é©—ï¼Œè©¦è‘—é‡ç¾å…¶ä¸­å¹¾ç¨®ç‹€æ³ï¼Œç”±æ–¼æˆ‘å€‹äººç†è§£ç¨‹åº¦é‚„ä¸å¤ æ·±ï¼Œå»ºè­°å»é–±è®€åƒè€ƒè³‡æºçš„æ–‡ç« æœƒæ”¶ç©«æ›´å¤šå–”ï¼&lt;/p>
&lt;p>å…ˆä¾†ä¸€æ®µå®˜æ–¹çš„ä»‹ç´¹ï¼Œè©³ç´°çš„å…§å®¹åœ¨ &lt;a class="link" href="https://docs.postgresql.tw/the-sql-language/concurrency-control/introduction" target="_blank" rel="noopener"
>PostgreSQL MVCC ç°¡ä»‹&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>PostgreSQL ç‚ºé–‹ç™¼è€…å€‘æä¾›äº†è±å¯Œçš„å·¥å…·ä¾†ç®¡ç†è³‡æ–™çš„ &lt;strong>åŒæ™‚å­˜å–&lt;/strong>ã€‚è³‡æ–™çš„ &lt;strong>ä¸€è‡´æ€§&lt;/strong> åœ¨è³‡æ–™åº«å…§éƒ¨æ˜¯ä»¥ &lt;strong>å¤šé‡è³‡æ–™ç‰ˆæœ¬çš„æ–¹å¼ç¶­è­·ï¼ˆMultiversion Concurrency Controlï¼ŒMVCCï¼‰&lt;/strong>ï¼Œé€™è¡¨ç¤ºç„¡è«–ç›®å‰è³‡æ–™çš„ç•¶ä¸‹ç‹€æ…‹å¦‚ä½•ï¼Œæ¯å€‹ SQL æŒ‡ä»¤æœƒçœ‹è¦‹çš„æ˜¯è³‡æ–™åœ¨ä¸€æ®µæ™‚é–“å‰çš„ &lt;strong>å¿«ç…§&lt;/strong> ï¼ˆè³‡æ–™åº«çš„æŸå€‹ç‰ˆæœ¬ï¼‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>è€ŒMVCCé€™å€‹åŠŸèƒ½å¤§å¤šæ•¸è³‡æ–™åº«å·²ç¶“å¯¦ç¾äº†ï¼Œè©³ç´°åƒè€ƒ &lt;a class="link" href="https://zh.wikipedia.org/zh-tw/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener"
>ç¶­åŸºç™¾ç§‘-å¤šç‰ˆæœ¬ä¸¦è¡Œæ§åˆ¶&lt;/a> ã€‚&lt;/p>
&lt;p>é€™æ¬¡å¯¦é©—çš„ç¯„åœä»¥ &lt;strong>äº¤æ˜“éš”é›¢(Transaction Isolation)&lt;/strong> ç‚ºä¸» ï¼Œä»¥æˆ‘å€‹äººæ ¹æ“šå®˜æ–¹æ‰‹å†Šæä¾›çš„è§£é‡‹åŠç¯„ä¾‹ä¾†åšå¯¦é©—ï¼Œè‹¥éç¨‹ä¸­æœ‰éŒ¯èª¤èªçŸ¥ä¹Ÿè«‹ä¸åå‘ŠçŸ¥ï¼&lt;/p>
&lt;h2 id="å°è©¦èº«æ‰‹">å°è©¦èº«æ‰‹&lt;/h2>
&lt;p>å¯ä»¥å…ˆåˆ° &lt;a class="link" href="https://www.crunchydata.com/developers/playground/transactions" target="_blank" rel="noopener"
>Crunchydata Tutorials - Transactions&lt;/a> å»è©¦ä¸€é postgres ä¸­çš„ transaction è¡Œç‚ºï¼Œç…§è‘—åšä¹‹å¤–ä¹Ÿå¯ä»¥å»è©¦è‘—ç†è§£æ•™å­¸çš„é‡é»å–”ï¼&lt;/p>
&lt;h2 id="sql-transaction">SQL &lt;strong>Transaction&lt;/strong>&lt;/h2>
&lt;p>åœ¨å¯¦é©—å‰å…ˆä¾†è¤‡ç¿’ä¸€ä¸‹ &lt;strong>è³‡æ–™åº«äº¤æ˜“è¡Œç‚º(Transaction)&lt;/strong> çš„ç‰¹æ€§ï¼Œä»¥ä¸‹ç¯€éŒ„è‡ª &lt;a class="link" href="https://totoroliu.medium.com/%E8%B3%87%E6%96%99%E5%BA%AB-acid-bb87324035a8" target="_blank" rel="noopener"
>SQL å¤§å°äº‹ - Po-Ching **Liu&lt;/a>ã€‚**&lt;/p>
&lt;hr>
&lt;p>åœ¨è³‡æ–™åº«ä¸­ï¼Œ&lt;strong>äº¤æ˜“(äº‹å‹™)&lt;/strong> æ„æ—¨ç”±å„ç¨® &lt;strong>è³‡æ–™åº«æ“ä½œ(selectã€updateã€insertç­‰)&lt;/strong> æ‰€çµ„æˆçš„é‚è¼¯éç¨‹ã€‚&lt;/p>
&lt;p>åœ¨è³‡æ–™åº«ä¸­ç‚ºä¿è­‰å…¶äº¤æ˜“æ˜¯æ­£ç¢ºä¸”å¯é çš„ï¼Œå¿…éœ€æ»¿è¶³ä»¥ä¸‹ &lt;strong>å››å€‹ç‰¹æ€§&lt;/strong> ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>åŸå­æ€§(Atomicity)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åœ¨è³‡æ–™åº«çš„æ¯ä¸€ç­†äº¤æ˜“ä¸­åªæœ‰å…©ç¨®å¯èƒ½ç™¼ç”Ÿï¼Œç¬¬ä¸€ç¨®æ˜¯å…¨éƒ¨å®Œå…¨(commit)ï¼Œç¬¬äºŒç¨®æ˜¯å…¨éƒ¨ä¸å®Œæˆ(rollback)ï¼Œä¸æœƒå› ç‚ºæŸå€‹ç’°ç¯€å‡ºéŒ¯ï¼Œè€Œçµ‚æ­¢åœ¨é‚£å€‹ç’°ç¯€ï¼Œåœ¨å‡ºéŒ¯ä¹‹å¾Œæœƒæ¢å¾©è‡³äº¤æ˜“ä¹‹å‰çš„ç‹€æ…‹ï¼Œå¦‚åŒé‚„æ²’åŸ·è¡Œæ­¤ç­†äº¤æ˜“ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ä¸€è‡´æ€§(Consistency)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åœ¨äº¤æ˜“ä¸­æœƒç”¢ç”Ÿè³‡æ–™æˆ–è€…é©—è­‰ç‹€æ…‹ï¼Œç„¶è€Œç•¶éŒ¯èª¤ç™¼ç”Ÿï¼Œæ‰€æœ‰å·²æ›´æ”¹çš„è³‡æ–™æˆ–ç‹€æ…‹å°‡æœƒæ¢å¾©è‡³äº¤æ˜“ä¹‹å‰ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>éš”é›¢æ€§(Isolation)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>è³‡æ–™åº«å…è¨±å¤šç­†äº¤æ˜“åŒæ™‚é€²è¡Œï¼Œäº¤æ˜“é€²è¡Œæ™‚æœªå®Œæˆçš„äº¤æ˜“è³‡æ–™ä¸¦ä¸æœƒè¢«å…¶ä»–äº¤æ˜“ä½¿ç”¨ï¼Œç›´åˆ°æ­¤ç­†äº¤æ˜“å®Œæˆã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æŒçºŒæ€§(Durability)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>äº¤æ˜“å®Œæˆå¾Œå°è³‡æ–™çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ï¼Œè³‡æ–™ä¸æœƒå› ç‚ºç³»çµ±é‡å•Ÿæˆ–éŒ¯èª¤è€Œæ”¹è®Šã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="ä»€éº¼æ˜¯-äº¤æ˜“éš”é›¢transaction-isolation-">ä»€éº¼æ˜¯ äº¤æ˜“éš”é›¢(Transaction Isolation) ?&lt;/h2>
&lt;p>ä»¥ä¸‹ç¯€éŒ„è‡ª &lt;a class="link" href="https://docs.postgresql.tw/the-sql-language/concurrency-control/transaction-isolation" target="_blank" rel="noopener"
>PostgreSQL äº¤æ˜“éš”é›¢&lt;/a> åŠ &lt;a class="link" href="https://hackmd.io/@Burgess/SkDnHKMNr" target="_blank" rel="noopener"
>è³‡æ–™åº« Transaction &amp;amp; Lock ç­†è¨˜ã€‚&lt;/a>&lt;/p>
&lt;hr>
&lt;p>åœ¨ä¸åŒç­‰ç´šä¸­ç™¼ç”Ÿ &lt;strong>ç«¶çˆ­æ¢ä»¶(Race condition)&lt;/strong> æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Dirty write (é«’å¯«)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>transaction å°šæœª commit çš„æƒ…æ³ä¸‹ï¼Œå…¶å€¼è¢«å¦ä¸€å€‹ transaction çµ¦è¦†å¯«ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Dirty read (é«’è®€)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>transaction è®€å–çš„è³‡æ–™æ˜¯ç”±å°šæœª commit çš„ concurrency transaction å¯«å…¥çš„ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Non-repeatable read (ç„¡æ³•é‡è¤‡çš„è®€å–)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åˆå¯ç¨±ä½œ &lt;strong>è®€å–åå·®(read skew)&lt;/strong> ï¼Œtransaction é‡æ–°è®€å–å®ƒä¹‹å‰è®€éçš„è³‡æ–™ï¼Œä½†æ˜¯å»ç™¼ç¾è³‡æ–™è¢«å…¶ä»– transaction ä¿®æ”¹ï¼ˆåœ¨æœ€åˆè®€å–ä¹‹å¾Œcommitï¼‰äº†ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Phantom read (å¹»è®€)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åˆå¯ç¨±ä½œ &lt;strong>å¯«å…¥åå·®(wirte skew)&lt;/strong> ï¼Œtransaction é‡æ–°åŸ·è¡ŒæŸ¥è©¢ï¼Œå¾—åˆ°æ»¿è¶³æœå°‹æ¢ä»¶çš„è³‡æ–™é›†ï¼Œä½†å»ç™¼ç¾å¾—åˆ°çš„è³‡æ–™é›†å› ç‚ºå…¶ä»–æœ€è¿‘å‰› commit çš„ transaction è€Œè®Šæ›´äº†ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Serialization anomaly (åºåˆ—åŒ–ç•°å¸¸)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åœ¨æˆåŠŸæäº¤ä¸€ç¾¤ transactions å¾Œï¼Œçµæœèˆ‡ä»¥æ‰€æœ‰å¯èƒ½çš„é †åºä¾åºåŸ·è¡Œäº¤æ˜“çš„çµæœéƒ½ä¸ä¸€è‡´ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>SQL æ¨™æº–ä¸­å®šç¾©äº†&lt;strong>å››å€‹ç­‰ç´šçš„äº¤æ˜“éš”é›¢ :&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Read uncommitted :&lt;/strong>
ä»£è¡¨ transaction å¯ä»¥è®€åˆ°åˆ¥çš„ transaction &lt;strong>å°šæœª commit&lt;/strong> çš„è³‡æ–™ï¼Œåœ¨é€™å€‹ç­‰ç´šä¸­ race condition ä¸‰å€‹å•é¡Œéƒ½æ²’æœ‰è§£æ±ºã€‚&lt;/li>
&lt;li>&lt;strong>Read committed :&lt;/strong>
ä»£è¡¨ transaction åªèƒ½è®€åˆ°åˆ¥çš„ transaction &lt;strong>å·²ç¶“ commit&lt;/strong> çš„è³‡æ–™ï¼Œæ²’æœ‰ commit çš„è©±å°±ä¸æœƒè®€åˆ°ï¼Œåœ¨é€™å€‹ç­‰ç´š&lt;strong>è§£æ±ºäº† Dirty read&lt;/strong> çš„å•é¡Œï¼Œç‚º &lt;strong>Postgres é è¨­ç­‰ç´š&lt;/strong>ã€‚&lt;/li>
&lt;li>&lt;strong>Repeatable read :&lt;/strong>
ä»£è¡¨æ¯æ¬¡ transaction è¦è®€å–ç‰¹å®šæ¬„ä½çš„è³‡æ–™æ™‚ï¼Œåªè¦ &lt;strong>query æ¢ä»¶ç›¸åŒ&lt;/strong>ï¼Œ&lt;strong>è®€å–åˆ°çš„è³‡æ–™å…§å®¹å°±æœƒç›¸åŒï¼Œ&lt;strong>åœ¨é€™å€‹ç­‰ç´š&lt;/strong>è§£æ±ºäº† Non-repeatable read&lt;/strong> çš„å•é¡Œï¼Œç‚º &lt;strong>MYSQL InnoDB é è¨­ç­‰ç´š&lt;/strong> ã€‚&lt;/li>
&lt;li>&lt;strong>Serializable :&lt;/strong>
ä»£è¡¨åœ¨å¤šå€‹ transaction åŒæ™‚åŸ·è¡Œæ™‚ï¼Œåªè¦ &lt;strong>transaction çš„é †åºç›¸åŒæ™‚ï¼Œå¾—åˆ°çš„çµæœä¸€å®šç›¸åŒ&lt;/strong>ã€‚æ¯”å¦‚èªª Transaction A å…ˆåŸ·è¡Œäº†æ¥ä¸‹ä¾†å†åŸ·è¡Œ Transaction Bï¼Œåœ¨åŒæ¨£çš„æ¢ä»¶ä¸‹ï¼Œæ¯æ¬¡åŸ·è¡Œéƒ½æœƒå¾—åˆ°ä¸€æ¨£çš„çµæœï¼Œåœ¨é€™å€‹ç­‰ç´šä¸‹é€£åŒ &lt;strong>Phantom read ä¹Ÿæœƒä¸€ä½µè¢«è§£æ±º&lt;/strong>ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="äº¤æ˜“éš”é›¢ç­‰ç´šèˆ‡ç«¶çˆ­æ¢ä»¶">äº¤æ˜“éš”é›¢ç­‰ç´šèˆ‡ç«¶çˆ­æ¢ä»¶&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>éš”é›¢ç­‰ç´š&lt;/th>
&lt;th>Dirty write&lt;/th>
&lt;th>Dirty read&lt;/th>
&lt;th>Non-repeatable read&lt;/th>
&lt;th>Phantom read&lt;/th>
&lt;th>Serialization anomaly&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Read uncommitted&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>å…è¨±ï¼Œä½†PGä¸­ä¸æœƒ&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Read committed&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Repeatable read&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>å…è¨±ï¼Œä½†PGä¸­ä¸æœƒ&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Serializable&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;blockquote>
&lt;p>&lt;a class="link" href="https://ithelp.ithome.com.tw/users/20130395/ironman/4188" target="_blank" rel="noopener"
>è³‡æ–™å·¥ç¨‹å¸«ä¿®ç…‰ä¹‹è·¯ Part II&lt;/a> IThome éµäººè³½ä¸­çš„ç³»åˆ—æ–‡ç« ï¼Œæœ‰é™„åœ–è€Œä¸”è§£é‡‹çš„æ›´è©³ç´°ï¼Œéå¸¸æ¨è–¦å»é–±è®€ï¼&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¯¦é©—ç’°å¢ƒ">å¯¦é©—ç’°å¢ƒ&lt;/h2>
&lt;ul>
&lt;li>Mac M1&lt;/li>
&lt;li>Docker 20.10.17&lt;/li>
&lt;li>Docker Compose 2.2.3&lt;/li>
&lt;li>Docker Image: &lt;code>postgres:14-alpine&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="æ¨¡æ“¬-race-condition-ç™¼ç”Ÿ">æ¨¡æ“¬ race condition ç™¼ç”Ÿ&lt;/h2>
&lt;blockquote>
&lt;p>ç”±æ–¼åœ¨ RDBMS ä¸­çš„ transaction ä¸å…è¨± &lt;strong>dirty write(é«’å¯«)&lt;/strong> çš„ç‹€æ³ç™¼ç”Ÿï¼Œæœ‰é—œå…¶ç‹€æ³å¯ä»¥åƒè€ƒå…¶ä»–æ–‡ç« è§£é‡‹ï¼Œè€Œ &lt;strong>serialization anomaly(åºåˆ—åŒ–ç•°å¸¸)&lt;/strong> æˆ‘é‚„ä¸æ¸…æ¥šå¦‚ä½•é‡ç¾ğŸ¥²ï¼Œ&lt;strong>dirty read(é«’è®€)&lt;/strong> åœ¨ postgres ä¸­ä¹Ÿè¢«é™åˆ¶ï¼Œé€™é‚Šå°±å…ˆè©¦è‘—é‡ç¾ä¸€ç¨® race condition çš„ç‹€æ³ï¼Œä¸¦è§€å¯Ÿä¿®æ”¹ isolation ç­‰ç´šå‰å¾Œçš„çµæœã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="non---repeatable-readread-skew">Non - Repeatable Read(Read skew)&lt;/h3>
&lt;p>æ¨¡æ“¬åœ¨ &lt;strong>Read committed&lt;/strong> ç­‰ç´šåº•ä¸‹æœƒç™¼ç”Ÿçš„å•é¡Œã€‚&lt;/p>
&lt;p>åƒè€ƒä»¥ä¸‹æƒ…å¢ƒé€²è¡Œå¯¦é©—ï¼š&lt;/p>
&lt;ul>
&lt;li>Alice æ“æœ‰å…©å€‹éŠ€è¡Œå¸³æˆ¶ï¼Œå„æœ‰ 500 å…ƒåœ¨å¸³æˆ¶ä¸­ï¼Œå…±æœ‰ 1000 å…ƒ&lt;/li>
&lt;li>æœ‰å€‹è½‰å¸³ä½œæ¥­ç™¼èµ· transaction å¾ Account 1 è½‰å¸³è‡³ Account 2&lt;/li>
&lt;li>Alice ç™¼èµ·çš„ transaction åœ¨&lt;strong>è½‰å¸³å‰&lt;/strong>æŸ¥äº† Account 1 ï¼Œåœ¨&lt;strong>è½‰å¸³å¾Œ&lt;/strong>æŸ¥äº† Account 2ï¼Œå¾—åˆ°ç¸½é¡ 900å…ƒçš„è³‡è¨Šï¼Œç™¼ç¾ç¸½é‡‘é¡å°‘äº† 100 å…ƒï¼Œä½†å¸³æˆ¶ä¸­ç¸½é¡ç¢ºå¯¦ç‚º 1000 å…ƒ&lt;/li>
&lt;li>Alice éœ€è¦å†æ¬¡æŸ¥è©¢æ‰å¯å–å¾—æ­£ç¢ºçš„çµæœ&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/figure_7-6.png"
loading="lazy"
alt="figure_7-6.png"
>&lt;/p>
&lt;p>é€™å€‹æƒ…å¢ƒä¸‹ç¬¦åˆ Read committed ç­‰ç´šä¸­å…è¨±è®€å–å·² committed çš„è³‡æ–™ï¼Œä½†æ²’æœ‰ä¿è­‰åœ¨åŒä¸€å€‹ transaction ä¸‹ï¼Œæ‰€å–å¾—çš„è³‡æ–™éƒ½æ˜¯åŒä¸€ä»½ã€‚&lt;/p>
&lt;hr>
&lt;p>GitHub repoï¼š &lt;a class="link" href="https://github.com/zeroLR/first-try-transaction-isolation" target="_blank" rel="noopener"
>https://github.com/zeroLR/first-try-transaction-isolation&lt;/a>&lt;/p>
&lt;p>å»ºç«‹è³‡æ–™å¤¾&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mkdir -p first-try-transaction-isolation/non-repeatable-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> first-try-transaction-isolation/non-repeatable-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">touch docker-compose.yml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>docker-compose é…ç½®&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3.1&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">db&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">container_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pg&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres:14-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">POSTGRES_DB&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">POSTGRES_USER&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">POSTGRES_PASSWORD&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">working_dir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/src&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># ç›´æ¥æŠŠç¾åœ¨è³‡æ–™å¤¾å…§å®¹æ˜ å°„è‡³å»ºç«‹çš„containerä¸­ï¼Œcopyæ‰€éœ€æª”æ¡ˆé€²å»æ¯”è¼ƒå¥½ï¼Œé€™é‚Šåƒ…ç‚ºäº†æ–¹ä¾¿æ“ä½œ&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">.:/usr/src&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å•Ÿå‹• container çš„é †åºä¸å½±éŸ¿æ˜ å°„åˆ° container ä¸­çš„æª”æ¡ˆï¼Œé€™é‚Šå°±å…ˆå•Ÿå‹•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo docker-compose up -d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å»ºç«‹ sql æª”&lt;/p>
&lt;p>&lt;strong>initdb.sql&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">BEGIN&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IF&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">EXISTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">SERIAL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">INT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>alice.sql&lt;/strong>(è¨»è§£é‚£è¡Œè¡¨ç¤ºè¨­å®šæ­¤transactionçš„éš”é›¢ç­‰ç´š)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">BEGIN&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>transfer.sql&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">BEGIN&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å»ºç«‹ shell script&lt;/p>
&lt;p>&lt;strong>lab.sh&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/usr/src/non-repeatable-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åŸ·è¡Œ initdb ä¸­çš„ query åˆå§‹åŒ–å¯¦é©—ç’°å¢ƒ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -U postgres -f &lt;span class="nv">$path&lt;/span>/initdb.sql --out log.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å°‡å…©å€‹åŸ·è¡Œ transaction æ”¾åˆ°èƒŒæ™¯ä¸¦ç™¼åŸ·è¡Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -U postgres -f &lt;span class="nv">$path&lt;/span>/alice.sql &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -U postgres -f &lt;span class="nv">$path&lt;/span>/transfer.sql &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>start.sh&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RED&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\033[0;31m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">BLUE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\033[0;34m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GREEN&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\033[0;32m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">NC&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\033[0m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/usr/src/non-repeatable-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">cycle&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">300&lt;/span> &lt;span class="c1"># åŸ·è¡Œæ¬¡æ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">snapshotAfterTransaction&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="c1"># å¦ä¸€ç­† transaction commit å‰å–å¾—çš„å¿«ç…§è¨ˆæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">snapshotBeforeTransaction&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="c1"># å¦ä¸€ç­† transaction commit å¾Œå–å¾—çš„å¿«ç…§è¨ˆæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">snapshotNonRepeatable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="c1"># å¦ä¸€ç­† transaction ä¸­å–åˆ°ä¸åŒå¿«ç…§è¨ˆæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>seq &lt;span class="m">1&lt;/span> &lt;span class="nv">$cycle&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># åŸ·è¡Œ lab.sh ä¸­çš„æŒ‡ä»¤ï¼Œä¸¦éæ¿¾å‡ºæœ‰400ã€500ã€600çš„çµæœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">output&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>sh &lt;span class="nv">$path&lt;/span>/lab.sh &lt;span class="p">|&lt;/span> grep -E &lt;span class="s1">&amp;#39;400|500|600&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å„²å­˜å„ç¨®ç‹€æ³çµæœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## å…©ç­†è³‡æ–™çš†æ˜¯å¦ä¸€ç­† transaction commit å¾Œçš„å¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">snapshot1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$output&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;600 400&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## å…©ç­†è³‡æ–™çš†æ˜¯å¦ä¸€ç­† transaction begin å‰çš„å¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">snapshot2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$output&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;500 500&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ç¬¬ä¸€ç­†è³‡æ–™ç‚ºå¦ä¸€ç­† transaction begin å‰çš„å¿«ç…§ï¼Œç¬¬äºŒç­†å‰‡ç‚º transaction commit å¾Œçš„å¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">snapshot3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$output&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;500 400&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> ! -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$snapshot1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">let&lt;/span> snapshotAfterTransaction++
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">GREEN&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">$snapshot1&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NC&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> ! -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$snapshot2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">let&lt;/span> snapshotBeforeTransaction++
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BLUE&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">$snapshot2&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NC&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> ! -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$snapshot3&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">let&lt;/span> snapshotNonRepeatable++
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">RED&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">$snapshot3&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NC&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ä¸‰ç¨®ç‹€æ³çµæœçµ±è¨ˆ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$i&lt;/span> -eq &lt;span class="nv">$cycle&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">GREEN&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">AfterTransaction: &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">snapshotAfterTransaction&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">\n&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BLUE&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">BeforeTransaction: &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">snapshotBeforeTransaction&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">\n&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">RED&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">Non-repeatable: &lt;/span>&lt;span class="nv">$snapshotNonRepeatable&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NC&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æª”æ¡ˆæº–å‚™å¥½ä¹‹å¾Œï¼ŒåŸ·è¡Œ start.sh å³å¯é–‹å§‹å¯¦é©—ï¼Œä½¿ç”¨ time -p å¯ä»¥å¾—çŸ¥åŸ·è¡Œæ™‚é–“&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">time&lt;/span> -p sh start.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¯¦é©—çµæœ">å¯¦é©—çµæœ&lt;/h2>
&lt;h3 id="read-committed-postgres-é è¨­ç­‰ç´š">Read committed (postgres é è¨­ç­‰ç´š)&lt;/h3>
&lt;p>ä½¿ç”¨é è¨­éš”é›¢ç­‰ç´šï¼Œ300æ¬¡å¯¦é©—ä¸­æœ‰8æ¬¡å¾—åˆ°æœ‰å•é¡Œçš„çµæœã€‚&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/read-committed.png"
loading="lazy"
alt="æˆªåœ– 2022-10-23 ä¸Šåˆ1.13.50.png"
>&lt;/p>
&lt;h2 id="repeatable-read">Repeatable Read&lt;/h2>
&lt;p>è¨­å®š &lt;code>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ&lt;/code> å¾Œï¼Œ300æ¬¡å¯¦é©—ä¸­ç„¡ç™¼ç”Ÿä¸æ­£ç¢ºçš„çµæœï¼Œç›¸å°çš„å–å¾—å¦ä¸€äº¤æ˜“å¾Œçš„è³‡æ–™æ¬¡æ•¸è¼ƒå°‘ã€‚&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/repeatable-read.png"
loading="lazy"
alt="æˆªåœ– 2022-10-23 ä¸Šåˆ1.14.12.png"
>&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;ul>
&lt;li>å¦‚æœå†å°‡å¯¦é©—æ¬¡æ•¸æ‹‰é«˜æˆ–è¨±çµæœæœƒæ›´æº–ç¢ºï¼Œä¸éæˆ‘ä¹Ÿä¸æ˜¯å¾ˆç¢ºå®šé€™å€‹åšæ³•æœ‰æ²’æœ‰å…¶ä»–å•é¡Œï¼Œåªæ˜¯è¦ºå¾—èƒ½å¤ é‡ç¾åŒæ¨£çš„å•é¡Œä¸¦ä¸”å»è§£æ±ºå®ƒï¼Œæ˜¯ä¸€ä»¶è »æœ‰æˆå°±çš„äº‹ï¼Œé€™æ¬¡åªæœ‰å¯« Non-repeatable Read(read skew) çš„å¯¦é©—ï¼Œä¹‹å¾Œæœ‰ç©ºå†è©¦è©¦é‡ç¾ Phantom Read(write skew)ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://zh.wikipedia.org/zh-tw/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener"
>ç¶­åŸºç™¾ç§‘-å¤šç‰ˆæœ¬ä¸¦è¡Œæ§åˆ¶&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.crunchydata.com/developers/playground/transactions" target="_blank" rel="noopener"
>Crunchydata Tutorials - Transactions&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.postgresql.org/docs/14/transaction-iso.html" target="_blank" rel="noopener"
>PostgreSQL 14 transaction-iso&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://docs.postgresql.tw/the-sql-language/concurrency-control/introduction" target="_blank" rel="noopener"
>PostgreSQL MVCC ç°¡ä»‹&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://docs.postgresql.tw/the-sql-language/concurrency-control/transaction-isolation" target="_blank" rel="noopener"
>PostgreSQL äº¤æ˜“éš”é›¢&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://totoroliu.medium.com/%E8%B3%87%E6%96%99%E5%BA%AB-acid-bb87324035a8" target="_blank" rel="noopener"
>SQL å¤§å°äº‹&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://hackmd.io/@Burgess/SkDnHKMNr" target="_blank" rel="noopener"
>è³‡æ–™åº« Transaction &amp;amp; Lock ç­†è¨˜&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://ithelp.ithome.com.tw/users/20130395/ironman/4188" target="_blank" rel="noopener"
>è³‡æ–™å·¥ç¨‹å¸«ä¿®ç…‰ä¹‹è·¯ Part II&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>