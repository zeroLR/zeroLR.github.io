<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Docker on Zero's Blog</title><link>https://blog.zerolr.net/categories/docker/</link><description>Recent content in Docker on Zero's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sat, 22 Oct 2022 17:57:01 +0000</lastBuildDate><atom:link href="https://blog.zerolr.net/categories/docker/index.xml" rel="self" type="application/rss+xml"/><item><title>ã€PostgreSQLã€‘åˆæ¢ Transaction Isolation</title><link>https://blog.zerolr.net/p/2022/10/22/first-try-transaction-isolation/</link><pubDate>Sat, 22 Oct 2022 17:57:01 +0000</pubDate><guid>https://blog.zerolr.net/p/2022/10/22/first-try-transaction-isolation/</guid><description>&lt;img src="https://blog.zerolr.net/assets/images/pg.jpeg" alt="Featured image of post ã€PostgreSQLã€‘åˆæ¢ Transaction Isolation" />&lt;blockquote>
&lt;p>æœ€è¿‘é¢è©¦è¢«å•åˆ°æœ‰é—œ &lt;strong>Transaction&lt;/strong> çš„å•é¡Œæ™‚ï¼Œå¹¾ä¹ç­”ä¸å‡ºä¾†Orzï¼Œè¶•ç·ŠæŸ¥è³‡æ–™ä¾†å£“å£“é©šã€‚&lt;/p>
&lt;/blockquote>
&lt;p>é€™ç¯‡æˆ‘æœƒå¾å®˜æ–¹æ–‡ä»¶åŠç¶²è·¯æ–‡ç« æ“·å–éƒ¨åˆ†å…§å®¹ï¼Œè©¦è‘—ç†è§£ &lt;a class="link" href="https://www.postgresql.org/docs/14/transaction-iso.html" target="_blank" rel="noopener"
>Postgres ä¸­çš„ Transaction&lt;/a> ï¼Œç”¨ Docker å»ºç«‹ Postgres ä¾†åšå¯¦é©—ï¼Œè©¦è‘—é‡ç¾å…¶ä¸­å¹¾ç¨®ç‹€æ³ï¼Œç”±æ–¼æˆ‘å€‹äººç†è§£ç¨‹åº¦é‚„ä¸å¤ æ·±ï¼Œå»ºè­°å»é–±è®€åƒè€ƒè³‡æºçš„æ–‡ç« æœƒæ”¶ç©«æ›´å¤šå–”ï¼&lt;/p>
&lt;p>å…ˆä¾†ä¸€æ®µå®˜æ–¹çš„ä»‹ç´¹ï¼Œè©³ç´°çš„å…§å®¹åœ¨ &lt;a class="link" href="https://docs.postgresql.tw/the-sql-language/concurrency-control/introduction" target="_blank" rel="noopener"
>PostgreSQL MVCC ç°¡ä»‹&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>PostgreSQL ç‚ºé–‹ç™¼è€…å€‘æä¾›äº†è±å¯Œçš„å·¥å…·ä¾†ç®¡ç†è³‡æ–™çš„ &lt;strong>åŒæ™‚å­˜å–&lt;/strong>ã€‚è³‡æ–™çš„ &lt;strong>ä¸€è‡´æ€§&lt;/strong> åœ¨è³‡æ–™åº«å…§éƒ¨æ˜¯ä»¥ &lt;strong>å¤šé‡è³‡æ–™ç‰ˆæœ¬çš„æ–¹å¼ç¶­è­·ï¼ˆMultiversion Concurrency Controlï¼ŒMVCCï¼‰&lt;/strong>ï¼Œé€™è¡¨ç¤ºç„¡è«–ç›®å‰è³‡æ–™çš„ç•¶ä¸‹ç‹€æ…‹å¦‚ä½•ï¼Œæ¯å€‹ SQL æŒ‡ä»¤æœƒçœ‹è¦‹çš„æ˜¯è³‡æ–™åœ¨ä¸€æ®µæ™‚é–“å‰çš„ &lt;strong>å¿«ç…§&lt;/strong> ï¼ˆè³‡æ–™åº«çš„æŸå€‹ç‰ˆæœ¬ï¼‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>è€ŒMVCCé€™å€‹åŠŸèƒ½å¤§å¤šæ•¸è³‡æ–™åº«å·²ç¶“å¯¦ç¾äº†ï¼Œè©³ç´°åƒè€ƒ &lt;a class="link" href="https://zh.wikipedia.org/zh-tw/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener"
>ç¶­åŸºç™¾ç§‘-å¤šç‰ˆæœ¬ä¸¦è¡Œæ§åˆ¶&lt;/a> ã€‚&lt;/p>
&lt;p>é€™æ¬¡å¯¦é©—çš„ç¯„åœä»¥ &lt;strong>äº¤æ˜“éš”é›¢(Transaction Isolation)&lt;/strong> ç‚ºä¸» ï¼Œä»¥æˆ‘å€‹äººæ ¹æ“šå®˜æ–¹æ‰‹å†Šæä¾›çš„è§£é‡‹åŠç¯„ä¾‹ä¾†åšå¯¦é©—ï¼Œè‹¥éç¨‹ä¸­æœ‰éŒ¯èª¤èªçŸ¥ä¹Ÿè«‹ä¸åå‘ŠçŸ¥ï¼&lt;/p>
&lt;h2 id="å°è©¦èº«æ‰‹">å°è©¦èº«æ‰‹&lt;/h2>
&lt;p>å¯ä»¥å…ˆåˆ° &lt;a class="link" href="https://www.crunchydata.com/developers/playground/transactions" target="_blank" rel="noopener"
>Crunchydata Tutorials - Transactions&lt;/a> å»è©¦ä¸€é postgres ä¸­çš„ transaction è¡Œç‚ºï¼Œç…§è‘—åšä¹‹å¤–ä¹Ÿå¯ä»¥å»è©¦è‘—ç†è§£æ•™å­¸çš„é‡é»å–”ï¼&lt;/p>
&lt;h2 id="sql-transaction">SQL &lt;strong>Transaction&lt;/strong>&lt;/h2>
&lt;p>åœ¨å¯¦é©—å‰å…ˆä¾†è¤‡ç¿’ä¸€ä¸‹ &lt;strong>è³‡æ–™åº«äº¤æ˜“è¡Œç‚º(Transaction)&lt;/strong> çš„ç‰¹æ€§ï¼Œä»¥ä¸‹ç¯€éŒ„è‡ª &lt;a class="link" href="https://totoroliu.medium.com/%E8%B3%87%E6%96%99%E5%BA%AB-acid-bb87324035a8" target="_blank" rel="noopener"
>SQL å¤§å°äº‹ - Po-Ching **Liu&lt;/a>ã€‚**&lt;/p>
&lt;hr>
&lt;p>åœ¨è³‡æ–™åº«ä¸­ï¼Œ&lt;strong>äº¤æ˜“(äº‹å‹™)&lt;/strong> æ„æ—¨ç”±å„ç¨® &lt;strong>è³‡æ–™åº«æ“ä½œ(selectã€updateã€insertç­‰)&lt;/strong> æ‰€çµ„æˆçš„é‚è¼¯éç¨‹ã€‚&lt;/p>
&lt;p>åœ¨è³‡æ–™åº«ä¸­ç‚ºä¿è­‰å…¶äº¤æ˜“æ˜¯æ­£ç¢ºä¸”å¯é çš„ï¼Œå¿…éœ€æ»¿è¶³ä»¥ä¸‹ &lt;strong>å››å€‹ç‰¹æ€§&lt;/strong> ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>åŸå­æ€§(Atomicity)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åœ¨è³‡æ–™åº«çš„æ¯ä¸€ç­†äº¤æ˜“ä¸­åªæœ‰å…©ç¨®å¯èƒ½ç™¼ç”Ÿï¼Œç¬¬ä¸€ç¨®æ˜¯å…¨éƒ¨å®Œå…¨(commit)ï¼Œç¬¬äºŒç¨®æ˜¯å…¨éƒ¨ä¸å®Œæˆ(rollback)ï¼Œä¸æœƒå› ç‚ºæŸå€‹ç’°ç¯€å‡ºéŒ¯ï¼Œè€Œçµ‚æ­¢åœ¨é‚£å€‹ç’°ç¯€ï¼Œåœ¨å‡ºéŒ¯ä¹‹å¾Œæœƒæ¢å¾©è‡³äº¤æ˜“ä¹‹å‰çš„ç‹€æ…‹ï¼Œå¦‚åŒé‚„æ²’åŸ·è¡Œæ­¤ç­†äº¤æ˜“ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ä¸€è‡´æ€§(Consistency)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åœ¨äº¤æ˜“ä¸­æœƒç”¢ç”Ÿè³‡æ–™æˆ–è€…é©—è­‰ç‹€æ…‹ï¼Œç„¶è€Œç•¶éŒ¯èª¤ç™¼ç”Ÿï¼Œæ‰€æœ‰å·²æ›´æ”¹çš„è³‡æ–™æˆ–ç‹€æ…‹å°‡æœƒæ¢å¾©è‡³äº¤æ˜“ä¹‹å‰ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>éš”é›¢æ€§(Isolation)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>è³‡æ–™åº«å…è¨±å¤šç­†äº¤æ˜“åŒæ™‚é€²è¡Œï¼Œäº¤æ˜“é€²è¡Œæ™‚æœªå®Œæˆçš„äº¤æ˜“è³‡æ–™ä¸¦ä¸æœƒè¢«å…¶ä»–äº¤æ˜“ä½¿ç”¨ï¼Œç›´åˆ°æ­¤ç­†äº¤æ˜“å®Œæˆã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æŒçºŒæ€§(Durability)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>äº¤æ˜“å®Œæˆå¾Œå°è³‡æ–™çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ï¼Œè³‡æ–™ä¸æœƒå› ç‚ºç³»çµ±é‡å•Ÿæˆ–éŒ¯èª¤è€Œæ”¹è®Šã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="ä»€éº¼æ˜¯-äº¤æ˜“éš”é›¢transaction-isolation-">ä»€éº¼æ˜¯ äº¤æ˜“éš”é›¢(Transaction Isolation) ?&lt;/h2>
&lt;p>ä»¥ä¸‹ç¯€éŒ„è‡ª &lt;a class="link" href="https://docs.postgresql.tw/the-sql-language/concurrency-control/transaction-isolation" target="_blank" rel="noopener"
>PostgreSQL äº¤æ˜“éš”é›¢&lt;/a> åŠ &lt;a class="link" href="https://hackmd.io/@Burgess/SkDnHKMNr" target="_blank" rel="noopener"
>è³‡æ–™åº« Transaction &amp;amp; Lock ç­†è¨˜ã€‚&lt;/a>&lt;/p>
&lt;hr>
&lt;p>åœ¨ä¸åŒç­‰ç´šä¸­ç™¼ç”Ÿ &lt;strong>ç«¶çˆ­æ¢ä»¶(Race condition)&lt;/strong> æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Dirty write (é«’å¯«)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>transaction å°šæœª commit çš„æƒ…æ³ä¸‹ï¼Œå…¶å€¼è¢«å¦ä¸€å€‹ transaction çµ¦è¦†å¯«ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Dirty read (é«’è®€)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>transaction è®€å–çš„è³‡æ–™æ˜¯ç”±å°šæœª commit çš„ concurrency transaction å¯«å…¥çš„ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Non-repeatable read (ç„¡æ³•é‡è¤‡çš„è®€å–)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åˆå¯ç¨±ä½œ &lt;strong>è®€å–åå·®(read skew)&lt;/strong> ï¼Œtransaction é‡æ–°è®€å–å®ƒä¹‹å‰è®€éçš„è³‡æ–™ï¼Œä½†æ˜¯å»ç™¼ç¾è³‡æ–™è¢«å…¶ä»– transaction ä¿®æ”¹ï¼ˆåœ¨æœ€åˆè®€å–ä¹‹å¾Œcommitï¼‰äº†ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Phantom read (å¹»è®€)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åˆå¯ç¨±ä½œ &lt;strong>å¯«å…¥åå·®(wirte skew)&lt;/strong> ï¼Œtransaction é‡æ–°åŸ·è¡ŒæŸ¥è©¢ï¼Œå¾—åˆ°æ»¿è¶³æœå°‹æ¢ä»¶çš„è³‡æ–™é›†ï¼Œä½†å»ç™¼ç¾å¾—åˆ°çš„è³‡æ–™é›†å› ç‚ºå…¶ä»–æœ€è¿‘å‰› commit çš„ transaction è€Œè®Šæ›´äº†ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Serialization anomaly (åºåˆ—åŒ–ç•°å¸¸)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>åœ¨æˆåŠŸæäº¤ä¸€ç¾¤ transactions å¾Œï¼Œçµæœèˆ‡ä»¥æ‰€æœ‰å¯èƒ½çš„é †åºä¾åºåŸ·è¡Œäº¤æ˜“çš„çµæœéƒ½ä¸ä¸€è‡´ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>SQL æ¨™æº–ä¸­å®šç¾©äº†&lt;strong>å››å€‹ç­‰ç´šçš„äº¤æ˜“éš”é›¢ :&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Read uncommitted :&lt;/strong>
ä»£è¡¨ transaction å¯ä»¥è®€åˆ°åˆ¥çš„ transaction &lt;strong>å°šæœª commit&lt;/strong> çš„è³‡æ–™ï¼Œåœ¨é€™å€‹ç­‰ç´šä¸­ race condition ä¸‰å€‹å•é¡Œéƒ½æ²’æœ‰è§£æ±ºã€‚&lt;/li>
&lt;li>&lt;strong>Read committed :&lt;/strong>
ä»£è¡¨ transaction åªèƒ½è®€åˆ°åˆ¥çš„ transaction &lt;strong>å·²ç¶“ commit&lt;/strong> çš„è³‡æ–™ï¼Œæ²’æœ‰ commit çš„è©±å°±ä¸æœƒè®€åˆ°ï¼Œåœ¨é€™å€‹ç­‰ç´š&lt;strong>è§£æ±ºäº† Dirty read&lt;/strong> çš„å•é¡Œï¼Œç‚º &lt;strong>Postgres é è¨­ç­‰ç´š&lt;/strong>ã€‚&lt;/li>
&lt;li>&lt;strong>Repeatable read :&lt;/strong>
ä»£è¡¨æ¯æ¬¡ transaction è¦è®€å–ç‰¹å®šæ¬„ä½çš„è³‡æ–™æ™‚ï¼Œåªè¦ &lt;strong>query æ¢ä»¶ç›¸åŒ&lt;/strong>ï¼Œ&lt;strong>è®€å–åˆ°çš„è³‡æ–™å…§å®¹å°±æœƒç›¸åŒï¼Œ&lt;strong>åœ¨é€™å€‹ç­‰ç´š&lt;/strong>è§£æ±ºäº† Non-repeatable read&lt;/strong> çš„å•é¡Œï¼Œç‚º &lt;strong>MYSQL InnoDB é è¨­ç­‰ç´š&lt;/strong> ã€‚&lt;/li>
&lt;li>&lt;strong>Serializable :&lt;/strong>
ä»£è¡¨åœ¨å¤šå€‹ transaction åŒæ™‚åŸ·è¡Œæ™‚ï¼Œåªè¦ &lt;strong>transaction çš„é †åºç›¸åŒæ™‚ï¼Œå¾—åˆ°çš„çµæœä¸€å®šç›¸åŒ&lt;/strong>ã€‚æ¯”å¦‚èªª Transaction A å…ˆåŸ·è¡Œäº†æ¥ä¸‹ä¾†å†åŸ·è¡Œ Transaction Bï¼Œåœ¨åŒæ¨£çš„æ¢ä»¶ä¸‹ï¼Œæ¯æ¬¡åŸ·è¡Œéƒ½æœƒå¾—åˆ°ä¸€æ¨£çš„çµæœï¼Œåœ¨é€™å€‹ç­‰ç´šä¸‹é€£åŒ &lt;strong>Phantom read ä¹Ÿæœƒä¸€ä½µè¢«è§£æ±º&lt;/strong>ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="äº¤æ˜“éš”é›¢ç­‰ç´šèˆ‡ç«¶çˆ­æ¢ä»¶">äº¤æ˜“éš”é›¢ç­‰ç´šèˆ‡ç«¶çˆ­æ¢ä»¶&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>éš”é›¢ç­‰ç´š&lt;/th>
&lt;th>Dirty write&lt;/th>
&lt;th>Dirty read&lt;/th>
&lt;th>Non-repeatable read&lt;/th>
&lt;th>Phantom read&lt;/th>
&lt;th>Serialization anomaly&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Read uncommitted&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>å…è¨±ï¼Œä½†PGä¸­ä¸æœƒ&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Read committed&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Repeatable read&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>å…è¨±ï¼Œä½†PGä¸­ä¸æœƒ&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Serializable&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;blockquote>
&lt;p>&lt;a class="link" href="https://ithelp.ithome.com.tw/users/20130395/ironman/4188" target="_blank" rel="noopener"
>è³‡æ–™å·¥ç¨‹å¸«ä¿®ç…‰ä¹‹è·¯ Part II&lt;/a> IThome éµäººè³½ä¸­çš„ç³»åˆ—æ–‡ç« ï¼Œæœ‰é™„åœ–è€Œä¸”è§£é‡‹çš„æ›´è©³ç´°ï¼Œéå¸¸æ¨è–¦å»é–±è®€ï¼&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¯¦é©—ç’°å¢ƒ">å¯¦é©—ç’°å¢ƒ&lt;/h2>
&lt;ul>
&lt;li>Mac M1&lt;/li>
&lt;li>Docker 20.10.17&lt;/li>
&lt;li>Docker Compose 2.2.3&lt;/li>
&lt;li>Docker Image: &lt;code>postgres:14-alpine&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="æ¨¡æ“¬-race-condition-ç™¼ç”Ÿ">æ¨¡æ“¬ race condition ç™¼ç”Ÿ&lt;/h2>
&lt;blockquote>
&lt;p>ç”±æ–¼åœ¨ RDBMS ä¸­çš„ transaction ä¸å…è¨± &lt;strong>dirty write(é«’å¯«)&lt;/strong> çš„ç‹€æ³ç™¼ç”Ÿï¼Œæœ‰é—œå…¶ç‹€æ³å¯ä»¥åƒè€ƒå…¶ä»–æ–‡ç« è§£é‡‹ï¼Œè€Œ &lt;strong>serialization anomaly(åºåˆ—åŒ–ç•°å¸¸)&lt;/strong> æˆ‘é‚„ä¸æ¸…æ¥šå¦‚ä½•é‡ç¾ğŸ¥²ï¼Œ&lt;strong>dirty read(é«’è®€)&lt;/strong> åœ¨ postgres ä¸­ä¹Ÿè¢«é™åˆ¶ï¼Œé€™é‚Šå°±å…ˆè©¦è‘—é‡ç¾ä¸€ç¨® race condition çš„ç‹€æ³ï¼Œä¸¦è§€å¯Ÿä¿®æ”¹ isolation ç­‰ç´šå‰å¾Œçš„çµæœã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="non---repeatable-readread-skew">Non - Repeatable Read(Read skew)&lt;/h3>
&lt;p>æ¨¡æ“¬åœ¨ &lt;strong>Read committed&lt;/strong> ç­‰ç´šåº•ä¸‹æœƒç™¼ç”Ÿçš„å•é¡Œã€‚&lt;/p>
&lt;p>åƒè€ƒä»¥ä¸‹æƒ…å¢ƒé€²è¡Œå¯¦é©—ï¼š&lt;/p>
&lt;ul>
&lt;li>Alice æ“æœ‰å…©å€‹éŠ€è¡Œå¸³æˆ¶ï¼Œå„æœ‰ 500 å…ƒåœ¨å¸³æˆ¶ä¸­ï¼Œå…±æœ‰ 1000 å…ƒ&lt;/li>
&lt;li>æœ‰å€‹è½‰å¸³ä½œæ¥­ç™¼èµ· transaction å¾ Account 1 è½‰å¸³è‡³ Account 2&lt;/li>
&lt;li>Alice ç™¼èµ·çš„ transaction åœ¨&lt;strong>è½‰å¸³å‰&lt;/strong>æŸ¥äº† Account 1 ï¼Œåœ¨&lt;strong>è½‰å¸³å¾Œ&lt;/strong>æŸ¥äº† Account 2ï¼Œå¾—åˆ°ç¸½é¡ 900å…ƒçš„è³‡è¨Šï¼Œç™¼ç¾ç¸½é‡‘é¡å°‘äº† 100 å…ƒï¼Œä½†å¸³æˆ¶ä¸­ç¸½é¡ç¢ºå¯¦ç‚º 1000 å…ƒ&lt;/li>
&lt;li>Alice éœ€è¦å†æ¬¡æŸ¥è©¢æ‰å¯å–å¾—æ­£ç¢ºçš„çµæœ&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/figure_7-6.png"
loading="lazy"
alt="figure_7-6.png"
>&lt;/p>
&lt;p>é€™å€‹æƒ…å¢ƒä¸‹ç¬¦åˆ Read committed ç­‰ç´šä¸­å…è¨±è®€å–å·² committed çš„è³‡æ–™ï¼Œä½†æ²’æœ‰ä¿è­‰åœ¨åŒä¸€å€‹ transaction ä¸‹ï¼Œæ‰€å–å¾—çš„è³‡æ–™éƒ½æ˜¯åŒä¸€ä»½ã€‚&lt;/p>
&lt;hr>
&lt;p>GitHub repoï¼š &lt;a class="link" href="https://github.com/zeroLR/first-try-transaction-isolation" target="_blank" rel="noopener"
>https://github.com/zeroLR/first-try-transaction-isolation&lt;/a>&lt;/p>
&lt;p>å»ºç«‹è³‡æ–™å¤¾&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mkdir -p first-try-transaction-isolation/non-repeatable-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> first-try-transaction-isolation/non-repeatable-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">touch docker-compose.yml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>docker-compose é…ç½®&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3.1&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">db&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">container_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pg&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres:14-alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">POSTGRES_DB&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">POSTGRES_USER&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">POSTGRES_PASSWORD&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">postgres&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">working_dir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/src&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># ç›´æ¥æŠŠç¾åœ¨è³‡æ–™å¤¾å…§å®¹æ˜ å°„è‡³å»ºç«‹çš„containerä¸­ï¼Œcopyæ‰€éœ€æª”æ¡ˆé€²å»æ¯”è¼ƒå¥½ï¼Œé€™é‚Šåƒ…ç‚ºäº†æ–¹ä¾¿æ“ä½œ&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">.:/usr/src&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å•Ÿå‹• container çš„é †åºä¸å½±éŸ¿æ˜ å°„åˆ° container ä¸­çš„æª”æ¡ˆï¼Œé€™é‚Šå°±å…ˆå•Ÿå‹•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo docker-compose up -d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å»ºç«‹ sql æª”&lt;/p>
&lt;p>&lt;strong>initdb.sql&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">BEGIN&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IF&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">EXISTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">SERIAL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">INT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>alice.sql&lt;/strong>(è¨»è§£é‚£è¡Œè¡¨ç¤ºè¨­å®šæ­¤transactionçš„éš”é›¢ç­‰ç´š)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">BEGIN&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>transfer.sql&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">BEGIN&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">COMMIT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å»ºç«‹ shell script&lt;/p>
&lt;p>&lt;strong>lab.sh&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/usr/src/non-repeatable-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åŸ·è¡Œ initdb ä¸­çš„ query åˆå§‹åŒ–å¯¦é©—ç’°å¢ƒ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -U postgres -f &lt;span class="nv">$path&lt;/span>/initdb.sql --out log.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å°‡å…©å€‹åŸ·è¡Œ transaction æ”¾åˆ°èƒŒæ™¯ä¸¦ç™¼åŸ·è¡Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -U postgres -f &lt;span class="nv">$path&lt;/span>/alice.sql &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">psql -U postgres -f &lt;span class="nv">$path&lt;/span>/transfer.sql &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>start.sh&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RED&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\033[0;31m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">BLUE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\033[0;34m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GREEN&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\033[0;32m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">NC&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\033[0m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">path&lt;/span>&lt;span class="o">=&lt;/span>/usr/src/non-repeatable-read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">cycle&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">300&lt;/span> &lt;span class="c1"># åŸ·è¡Œæ¬¡æ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">snapshotAfterTransaction&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="c1"># å¦ä¸€ç­† transaction commit å‰å–å¾—çš„å¿«ç…§è¨ˆæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">snapshotBeforeTransaction&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="c1"># å¦ä¸€ç­† transaction commit å¾Œå–å¾—çš„å¿«ç…§è¨ˆæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">snapshotNonRepeatable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="c1"># å¦ä¸€ç­† transaction ä¸­å–åˆ°ä¸åŒå¿«ç…§è¨ˆæ•¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>seq &lt;span class="m">1&lt;/span> &lt;span class="nv">$cycle&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># åŸ·è¡Œ lab.sh ä¸­çš„æŒ‡ä»¤ï¼Œä¸¦éæ¿¾å‡ºæœ‰400ã€500ã€600çš„çµæœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">output&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>sh &lt;span class="nv">$path&lt;/span>/lab.sh &lt;span class="p">|&lt;/span> grep -E &lt;span class="s1">&amp;#39;400|500|600&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># å„²å­˜å„ç¨®ç‹€æ³çµæœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## å…©ç­†è³‡æ–™çš†æ˜¯å¦ä¸€ç­† transaction commit å¾Œçš„å¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">snapshot1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$output&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;600 400&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## å…©ç­†è³‡æ–™çš†æ˜¯å¦ä¸€ç­† transaction begin å‰çš„å¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">snapshot2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$output&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;500 500&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ç¬¬ä¸€ç­†è³‡æ–™ç‚ºå¦ä¸€ç­† transaction begin å‰çš„å¿«ç…§ï¼Œç¬¬äºŒç­†å‰‡ç‚º transaction commit å¾Œçš„å¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">snapshot3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$output&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s1">&amp;#39;500 400&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> ! -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$snapshot1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">let&lt;/span> snapshotAfterTransaction++
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">GREEN&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">$snapshot1&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NC&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> ! -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$snapshot2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">let&lt;/span> snapshotBeforeTransaction++
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BLUE&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">$snapshot2&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NC&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> ! -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$snapshot3&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">let&lt;/span> snapshotNonRepeatable++
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">RED&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">$snapshot3&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NC&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ä¸‰ç¨®ç‹€æ³çµæœçµ±è¨ˆ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$i&lt;/span> -eq &lt;span class="nv">$cycle&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">GREEN&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">AfterTransaction: &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">snapshotAfterTransaction&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">\n&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BLUE&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">BeforeTransaction: &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">snapshotBeforeTransaction&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">\n&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">RED&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">Non-repeatable: &lt;/span>&lt;span class="nv">$snapshotNonRepeatable&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NC&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æª”æ¡ˆæº–å‚™å¥½ä¹‹å¾Œï¼ŒåŸ·è¡Œ start.sh å³å¯é–‹å§‹å¯¦é©—ï¼Œä½¿ç”¨ time -p å¯ä»¥å¾—çŸ¥åŸ·è¡Œæ™‚é–“&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">time&lt;/span> -p sh start.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¯¦é©—çµæœ">å¯¦é©—çµæœ&lt;/h2>
&lt;h3 id="read-committed-postgres-é è¨­ç­‰ç´š">Read committed (postgres é è¨­ç­‰ç´š)&lt;/h3>
&lt;p>ä½¿ç”¨é è¨­éš”é›¢ç­‰ç´šï¼Œ300æ¬¡å¯¦é©—ä¸­æœ‰8æ¬¡å¾—åˆ°æœ‰å•é¡Œçš„çµæœã€‚&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/read-committed.png"
loading="lazy"
alt="æˆªåœ– 2022-10-23 ä¸Šåˆ1.13.50.png"
>&lt;/p>
&lt;h2 id="repeatable-read">Repeatable Read&lt;/h2>
&lt;p>è¨­å®š &lt;code>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ&lt;/code> å¾Œï¼Œ300æ¬¡å¯¦é©—ä¸­ç„¡ç™¼ç”Ÿä¸æ­£ç¢ºçš„çµæœï¼Œç›¸å°çš„å–å¾—å¦ä¸€äº¤æ˜“å¾Œçš„è³‡æ–™æ¬¡æ•¸è¼ƒå°‘ã€‚&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/repeatable-read.png"
loading="lazy"
alt="æˆªåœ– 2022-10-23 ä¸Šåˆ1.14.12.png"
>&lt;/p>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;ul>
&lt;li>å¦‚æœå†å°‡å¯¦é©—æ¬¡æ•¸æ‹‰é«˜æˆ–è¨±çµæœæœƒæ›´æº–ç¢ºï¼Œä¸éæˆ‘ä¹Ÿä¸æ˜¯å¾ˆç¢ºå®šé€™å€‹åšæ³•æœ‰æ²’æœ‰å…¶ä»–å•é¡Œï¼Œåªæ˜¯è¦ºå¾—èƒ½å¤ é‡ç¾åŒæ¨£çš„å•é¡Œä¸¦ä¸”å»è§£æ±ºå®ƒï¼Œæ˜¯ä¸€ä»¶è »æœ‰æˆå°±çš„äº‹ï¼Œé€™æ¬¡åªæœ‰å¯« Non-repeatable Read(read skew) çš„å¯¦é©—ï¼Œä¹‹å¾Œæœ‰ç©ºå†è©¦è©¦é‡ç¾ Phantom Read(write skew)ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://zh.wikipedia.org/zh-tw/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener"
>ç¶­åŸºç™¾ç§‘-å¤šç‰ˆæœ¬ä¸¦è¡Œæ§åˆ¶&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.crunchydata.com/developers/playground/transactions" target="_blank" rel="noopener"
>Crunchydata Tutorials - Transactions&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.postgresql.org/docs/14/transaction-iso.html" target="_blank" rel="noopener"
>PostgreSQL 14 transaction-iso&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://docs.postgresql.tw/the-sql-language/concurrency-control/introduction" target="_blank" rel="noopener"
>PostgreSQL MVCC ç°¡ä»‹&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://docs.postgresql.tw/the-sql-language/concurrency-control/transaction-isolation" target="_blank" rel="noopener"
>PostgreSQL äº¤æ˜“éš”é›¢&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://totoroliu.medium.com/%E8%B3%87%E6%96%99%E5%BA%AB-acid-bb87324035a8" target="_blank" rel="noopener"
>SQL å¤§å°äº‹&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://hackmd.io/@Burgess/SkDnHKMNr" target="_blank" rel="noopener"
>è³‡æ–™åº« Transaction &amp;amp; Lock ç­†è¨˜&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://ithelp.ithome.com.tw/users/20130395/ironman/4188" target="_blank" rel="noopener"
>è³‡æ–™å·¥ç¨‹å¸«ä¿®ç…‰ä¹‹è·¯ Part II&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>ã€Linuxã€‘Concurrency on sh</title><link>https://blog.zerolr.net/p/2022/10/16/concurrency-on-sh/</link><pubDate>Sun, 16 Oct 2022 19:56:56 +0000</pubDate><guid>https://blog.zerolr.net/p/2022/10/16/concurrency-on-sh/</guid><description>&lt;p>é€™ç¯‡ç´€éŒ„åœ¨ docker busybox ä¸­ä½¿ç”¨ shell script åŒæ™‚åŸ·è¡Œå¤šå€‹æŒ‡ä»¤ï¼Œæ¯”è¼ƒä½¿ç”¨ &lt;code>&amp;amp;&lt;/code> å°‡å‘½ä»¤å¸¶åˆ°èƒŒæ™¯åŸ·è¡Œèˆ‡åœ¨å‰æ™¯åŸ·è¡Œæ™‚çš„ç‹€æ³ï¼Œå¦‚ç†è§£æœ‰èª¤ä¹Ÿæ­¡è¿ç³¾æ­£ã€‚&lt;/p>
&lt;p>ç¨‹å¼ç¢¼æ”¾åœ¨ github: &lt;a class="link" href="https://github.com/zeroLR/concurrency-on-sh" target="_blank" rel="noopener"
>https://github.com/zeroLR/concurrency-on-sh&lt;/a>&lt;/p>
&lt;h2 id="å¯¦é©—ç’°å¢ƒ">å¯¦é©—ç’°å¢ƒ&lt;/h2>
&lt;ul>
&lt;li>Mac M1&lt;/li>
&lt;li>Docker 20.10.17&lt;/li>
&lt;li>Docker Compose 2.2.3&lt;/li>
&lt;li>Docker Image: &lt;code>busybox:latest&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="å»ºç«‹å¯¦é©—ç’°å¢ƒ">å»ºç«‹å¯¦é©—ç’°å¢ƒ&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>å»ºç«‹è³‡æ–™å¤¾ ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mkdir concurrency-on-sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> concurrency-on-sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ç”¢ç”Ÿæœ¬æ¬¡å¯¦é©—æª”æ¡ˆã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cat &lt;span class="s">&amp;lt;&amp;lt; &amp;#39;EOF&amp;#39; &amp;gt;&amp;gt; foreground.sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">sleep 3 ; echo &amp;#34;First job has been completed.&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">sleep 9 ; echo &amp;#34;Next job has been completed.&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">sleep 6 ; echo &amp;#34;All jobs have been completed.&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat &lt;span class="s">&amp;lt;&amp;lt; &amp;#39;EOF&amp;#39; &amp;gt;&amp;gt; background.sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">sleep 3 &amp;amp;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">echo $!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">sleep 9 &amp;amp;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">echo $!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">sleep 6 &amp;amp;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">echo $!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">wait -n
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">echo &amp;#34;First job has been completed.&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">wait -n
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">echo &amp;#34;Next job has been completed.&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">wait
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">echo &amp;#34;All jobs have been completed.&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat &lt;span class="s">&amp;lt;&amp;lt; &amp;#39;EOF&amp;#39; &amp;gt;&amp;gt; zombie.sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">for i in `seq 1 10`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> do
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> sleep 10 &amp;amp;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> echo $!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">done
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">wait
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨ docker æˆ– docker-compose å•Ÿå‹• containerï¼Œå°‡å¯¦é©—æª”æ¡ˆ mount è‡³ container ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># docker command&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo docker run -dti --restart always --workdir /home --mount &lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>bind,source&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">pwd&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">/&amp;#34;&lt;/span>,target&lt;span class="o">=&lt;/span>/home --name busybox busybox ash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># concurrency-on-sh/docker-compose.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;3.1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">busybox&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">container_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">busybox:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stdin_open&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tty&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">working_dir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/home&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ash&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">.:/home&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># docker-compose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo docker-compose up -d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>é–‹å•Ÿå…©å€‹ shell ï¼Œéƒ½ä½¿ç”¨ docker exec é€²å…¥ container çš„ shell ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo docker &lt;span class="nb">exec&lt;/span> -ti busybox busybox ash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>å…¶ä¸­ä¸€å€‹ shell åŸ·è¡Œ top é–‹å•Ÿç³»çµ±ç›£è¦–(æŒ‰ 1 å¯ä»¥é¡¯ç¤ºå„å€‹ CPU è³‡æº)ï¼Œå¾…æœƒå¯¦é©—æ™‚æ–¹ä¾¿è§€å¯Ÿ process çš„å¢æ¸›éç¨‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-8812.29.18.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ12.29.18.png"
>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="å‰æ™¯åŸ·è¡Œ">å‰æ™¯åŸ·è¡Œ&lt;/h2>
&lt;p>ä¸€èˆ¬åœ¨ shell ä¸­æœªåŠ ä¸Š &lt;code>&amp;amp;&lt;/code> çš„å‘½ä»¤å°±æœƒæ”¾åœ¨å‰æ™¯è™•ç†ï¼Œä¸”ä¸€æ¬¡åªæœƒè™•ç†ä¸€å€‹ processï¼Œä½¿ç”¨ shell script åŸ·è¡Œå¤šå€‹å‘½ä»¤æ™‚ï¼Œä¹Ÿæ˜¯ä¸€æ¬¡åªç”¢ç”Ÿä¸€å€‹ processï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">time&lt;/span> -p sh foreground.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>ä½¿ç”¨ time -p åŸ·è¡Œå‘½ä»¤ï¼Œæœƒå°‡ time -p å¾Œçš„å‘½ä»¤ä½œç‚ºå…¶å­ç¨‹åºåŸ·è¡Œï¼Œå†ç”±é€™å€‹å­ç¨‹åºä½œç‚ºçˆ¶ç¨‹åºåŸ·è¡Œ shell script ï¼Œç”¢ç”Ÿå‡ºæ–°çš„ç¨‹åº(æœ‰é»ç¹å£ XD)ï¼Œå¾…æ‰€æœ‰å­ç¨‹åºéƒ½åŸ·è¡Œå®Œç•¢å¾Œï¼Œå›å‚³å¾ç¨‹åºåŸ·è¡Œåˆ°çµæŸæ‰€ç¶“éçš„æ™‚é–“ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç¬¬ä¸€å€‹å­ç¨‹åºç­‰å¾… 3 ç§’ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.29.37.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.29.37.png"
>&lt;/p>
&lt;p>é–‹å§‹ç¬¬äºŒå€‹å­ç¨‹åºç­‰å¾… 9 ç§’ï¼Œå›å‚³ç¬¬ä¸€å€‹å­ç¨‹åºçµæŸå¾ŒåŸ·è¡Œçš„è¨Šæ¯ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.29.40.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.29.40.png"
>&lt;/p>
&lt;p>é–‹å§‹ç¬¬ä¸‰å€‹å­ç¨‹åºç­‰å¾… 6 ç§’ï¼Œå›å‚³ç¬¬äºŒå€‹å­ç¨‹åºçµæŸå¾ŒåŸ·è¡Œçš„è¨Šæ¯ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.29.48.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.29.48.png"
>&lt;/p>
&lt;p>æ‰€æœ‰ç¨‹åºçµæŸï¼Œå›å‚³è¨Šæ¯èˆ‡åŸ·è¡Œæ™‚é–“ï¼Œç¸½å…±èŠ±è²» 3+6+9 = 18 ç§’ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.29.54.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.29.54.png"
>&lt;/p>
&lt;h2 id="èƒŒæ™¯åŸ·è¡Œ">èƒŒæ™¯åŸ·è¡Œ&lt;/h2>
&lt;p>ç¾åœ¨å°‡å‰æ™¯åŸ·è¡Œçš„å‘½ä»¤æ”¾åˆ°èƒŒæ™¯åŸ·è¡Œï¼Œä¸¦å›å‚³å­ç¨‹åº PIDï¼Œä½¿ç”¨ &lt;code>wait&lt;/code> ç­‰å¾…ç¨‹åºçµæŸï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">time&lt;/span> -p sh background.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŒæ™‚ç”¢ç”Ÿä¸‰å€‹å­ç¨‹åºï¼Œæ”¾åœ¨èƒŒæ™¯ç”± Linux å»åšä¸¦ç™¼æˆ–å¹³è¡Œè™•ç†ï¼Œå…¶ä¸­ &lt;code>CPU&lt;/code> çš„æ¬„ä½è¡¨ç¤ºç•¶ä¸‹é€™å€‹ç¨‹åºæ˜¯ç”±å“ªå€‹ CPU è™•ç†çš„ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.31.36.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.31.36.png"
>&lt;/p>
&lt;p>ç¬¬ä¸€å€‹å­ç¨‹åºçµæŸï¼Œæ­¤æ™‚å…¶ä»–å­ç¨‹åºç¹¼çºŒå€’æ•¸ä¸­ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.31.38.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.31.38.png"
>&lt;/p>
&lt;p>ç¬¬ä¸‰å€‹å­ç¨‹åºå…ˆçµæŸäº†ï¼Œå› ç‚ºå·²ç¶“å€’æ•¸å®Œç•¢ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.31.40.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.31.40.png"
>&lt;/p>
&lt;p>æœ€å¾Œç¬¬äºŒå€‹å­ç¨‹åºçµæŸï¼Œç¸½å…±èŠ±è²» 9 ç§’ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.31.44.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.31.44.png"
>&lt;/p>
&lt;p>é€™é‚Šçš„ä¾‹å­åŠå‘½ä»¤çš„é‡éƒ½èˆ‰å¾—å¾ˆå°‘ï¼Œå»ºè­°å¯ä»¥è‡ªå·±è©¦è©¦ç”¨ &lt;code>for loop&lt;/code> å»ç”¢ç”Ÿå¤§é‡çš„å‘½ä»¤åŸ·è¡Œï¼Œä¸éé‚„è¦è€ƒæ…®å–®æ ¸åŠå¤šæ ¸çš„ç³»çµ±ä¸Šè™•ç†çš„å·®ç•°å–”ï¼ å¯ä»¥åƒè€ƒ &lt;strong>&lt;a class="link" href="https://www.google.com/url?sa=t&amp;amp;rct=j&amp;amp;q=&amp;amp;esrc=s&amp;amp;source=web&amp;amp;cd=&amp;amp;ved=2ahUKEwjn2_mguuX6AhUU4GEKHbACBIIQFnoECBUQAQ&amp;amp;url=https%3A%2F%2Fhackmd.io%2F%40owlfox%2FSyaTF2VgL%2Fhttps%253A%252F%252Fhackmd.io%252Fs%252FSkh_AaVix&amp;amp;usg=AOvVaw2MPz6QOe7v0wzttr70OaRN" target="_blank" rel="noopener"
>Concurrency ç¨‹å¼è¨­è¨ˆ - HackMD&lt;/a> ã€‚&lt;/strong>&lt;/p>
&lt;h2 id="æ®­å±ç¨‹åº">æ®­å±ç¨‹åº&lt;/h2>
&lt;h3 id="ç¨‹åºè¢«æ­£å¸¸å›æ”¶">ç¨‹åºè¢«æ­£å¸¸å›æ”¶&lt;/h3>
&lt;p>æˆ‘å€‘å…ˆä¾†çœ‹çœ‹æœ‰æ­£å¸¸ä½¿ç”¨ &lt;code>wait&lt;/code> ç­‰å¾…ç¨‹åºçµæŸçš„ç‹€æ³ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># use wait&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">time&lt;/span> -p sh zombie.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‘½ä»¤åŸ·è¡Œä¸­ï¼Œecho å…ˆå°‡æ‰€æœ‰å·²ç”¢ç”Ÿç¨‹åºçš„ PID é¡¯ç¤ºå‡ºä¾†ï¼Œè§€å¯Ÿä»¥ä¸‹çµæœ :&lt;/p>
&lt;ul>
&lt;li>æ¯å€‹ç¨‹åºçš„ PPID(çˆ¶ç¨‹åº) æ˜¯èª°ï¼Œçˆ¶ ç”¢ç”Ÿ(â†’) å­&lt;/li>
&lt;li>container â†’ &lt;code>shell(ash)&lt;/code>&lt;/li>
&lt;li>&lt;code>shell(ash)&lt;/code> â†’ &lt;code>time -p sh zombie.sh&lt;/code>&lt;/li>
&lt;li>&lt;code>time -p sh zombie.sh&lt;/code> â†’ &lt;code>sh zombie.sh&lt;/code>&lt;/li>
&lt;li>&lt;code>sh zombie.sh&lt;/code> â†’ &lt;code>sleep&lt;/code>&lt;/li>
&lt;li>&lt;code>time -p sh zombie.sh&lt;/code> ç¨‹åºåœ¨å‰æ™¯åŸ·è¡Œä¸¦ç­‰å¾…ä¸­&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.34.06.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.34.06.png"
>&lt;/p>
&lt;p>å‘½ä»¤çµæŸï¼Œæ‰€æœ‰çµæŸçš„å­ç¨‹åºéƒ½è¢«å…¶çˆ¶ç¨‹åºå›æ”¶ï¼Œç¨‹åºåŸ·è¡Œæ™‚é–“å…±ç´„ 10 ç§’(ä¸¦ç™¼åŸ·è¡Œ)ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.34.17.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.34.17.png"
>&lt;/p>
&lt;h3 id="ç¨‹åºçµæŸå¾Œæœªè¢«çˆ¶ç¨‹åºå›æ”¶">ç¨‹åºçµæŸå¾Œæœªè¢«çˆ¶ç¨‹åºå›æ”¶&lt;/h3>
&lt;p>å†ä¾†è©¦è©¦ä¸ä½¿ç”¨ &lt;code>wait&lt;/code> æ™‚ï¼Œç¨‹åºåŸ·è¡Œå®Œçš„ç‹€æ³ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># not use wait&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">time&lt;/span> -p sh zombie.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‘½ä»¤åŸ·è¡Œå¾Œé¦¬ä¸ŠçµæŸï¼Œèˆ‡å‰é¢çš„ç‹€æ³æœ‰äº›ä¸åŒï¼š&lt;/p>
&lt;ul>
&lt;li>ç¨‹åºåŸ·è¡Œæ™‚é–“ç´„ 0.01 ç§’ï¼Œé€™é‚Šçš„åŸ·è¡Œæ™‚é–“åªåŒ…å« &lt;code>time -p sh zombie.sh&lt;/code> åŠ &lt;code>sh zombie.sh&lt;/code> ç¨‹åº&lt;/li>
&lt;li>æ¯å€‹ &lt;code>sleep&lt;/code> ç¨‹åºå…¶ PPID ç‚º 1ï¼Œè€Œé€™å€‹ PID ç‚º 1 çš„ç¨‹åºæ˜¯ container å»ºç«‹å¾Œç”¢ç”Ÿçš„ç¬¬ä¸€å€‹ç¨‹åºï¼Œä¹Ÿå°±æ˜¯æœ€å‰é¢ docker run æ™‚çš„ command æ‰€ç”¢ç”Ÿçš„&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.34.36.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.34.36.png"
>&lt;/p>
&lt;p>ç¨‹åºçµæŸå¾Œï¼Œå…¶çˆ¶è¡Œç¨‹æ²’æœ‰å›æ”¶å­ç¨‹åºï¼Œå­ç¨‹åºè®Šæˆ &lt;strong>æ®­å±ç¨‹åº&lt;/strong>ï¼š&lt;/p>
&lt;p>&lt;img src="https://blog.zerolr.net/assets/images/e6-88-aa-e5-9c-96_2022-10-17_-e4-b8-8a-e5-8d-881.34.46.png"
loading="lazy"
alt="æˆªåœ– 2022-10-17 ä¸Šåˆ1.34.46.png"
>&lt;/p>
&lt;hr>
&lt;p>é‚£éº¼ç‚ºä»€éº¼æ²’ç”¨ &lt;code>wait&lt;/code> å°±æœƒè®“ç¨‹åºè®Šæˆç”± PID 1 çš„ç¨‹åºä¾†ç”¢ç”Ÿå‘¢ï¼Ÿ&lt;/p>
&lt;p>æˆ‘å€‘å¾ &lt;code>wait&lt;/code> çš„ manual page ä¸­å¯ä»¥å¾—çŸ¥ :&lt;/p>
&lt;blockquote>
&lt;p>If a &lt;strong>parent process terminates&lt;/strong>, then its &amp;ldquo;zombie&amp;rdquo; children (if any) are adopted by &lt;strong>init(1)&lt;/strong>, (or by the nearest &amp;ldquo;subreaper&amp;rdquo; process as defined through the use of the &lt;strong>prctl(2)&lt;/strong> PR_SET_CHILD_SUBREAPER operation);
&lt;strong>init(1) automatically performs a wait to remove the zombies.&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>å–”ï½ç”±æ–¼æœªä½¿ç”¨ &lt;code>wait&lt;/code> å»ç­‰å¾… &lt;code>zombie.sh&lt;/code> ç”¢ç”Ÿçš„èƒŒæ™¯ç¨‹åºåŸ·è¡Œå®Œç•¢ï¼Œæ‰€ä»¥åŸ·è¡Œ &lt;code>zombie.sh&lt;/code> çš„ç•¶ä¸‹ç¨‹åºå°±çµæŸäº†ï¼Œç”¢ç”Ÿå‡ºä¾†çš„å­ç¨‹åºæ‰¾ä¸åˆ°çˆ¹ï¼Œæœ€å¾Œå°±è¢«éš”å£è€ç‹ &lt;strong>init(1)&lt;/strong> æ”¶é¤Šäº†(Xï¼Œè€Œé€™å€‹ç¨‹åºåœ¨é€™å€‹å¯¦é©—ä¸­æ˜¯ç”± docker run çš„ command - ash æ‰€ç”¢ç”Ÿçš„ï¼Œæœ€å¾Œå¯ä»¥é€éä»¥ä¸‹å‘½ä»¤å»é€²å…¥ container ä¸­ PID 1 çš„ç¨‹åºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># é€€å‡ºç›®å‰çš„ shell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># é€²å…¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo docker attach busybox
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶å¾ŒæŒ‰å€‹ enterï¼Œæ®­å±ç¨‹åºå°±æœƒè¢«å›æ”¶äº† ã€‚&lt;/p>
&lt;h3 id="çµæœæ¯”è¼ƒ">çµæœæ¯”è¼ƒ&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>æœ‰ wait&lt;/th>
&lt;th>æ²’ wait&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>ç”±å…¶çˆ¶ç¨‹åºé€²è¡Œç­‰å¾…ä¸¦å›æ”¶&lt;/td>
&lt;td>ç”± PID 1 çš„ç¨‹åº init(1) æ¥æ”¶å­ç¨‹åºï¼Œä¸¦è‡ªå‹•åŠ å…¥ wait å»çµæŸæ®­å±ç¨‹åº&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>è€çˆ¹çµ¦ä½ é &lt;/td>
&lt;td>è€çˆ¹è·‘è·¯ï¼Œéš”å£è€ç‹å¥½å¿ƒæ”¶é¤Š&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="ç¸½çµ">ç¸½çµ&lt;/h2>
&lt;ul>
&lt;li>åŸæœ¬åªæ˜¯è¦ç´€éŒ„æ€éº¼æ¨£åŒæ™‚ä¸‹å‘½ä»¤ï¼Œçµæœæƒ³è¦å¼„å€‹æ¨¡æ“¬å¯¦é©—å°±æœƒæŒ–æ›´å¤šå‘ï¼Œä¸éä¹Ÿç®—æ¯”ä»¥å‰æ›´æ·±å…¥ä¸€é»é»æ¢è¨é‹ä½œéç¨‹ä¸­çš„åŸç†ï¼Œé€Ÿé€Ÿå¦¹ï¼&lt;/li>
&lt;/ul>
&lt;h2 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://linux-kernel-labs.github.io/refs/heads/master/lectures/smp.html#linux-kernel-concurrency-sources" target="_blank" rel="noopener"
>Symmetric Multi-Processing - Linux kernel concurrency sources&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/mirror/busybox/blob/master/procps/top.c" target="_blank" rel="noopener"
>busybox - procps/top.c&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://iter01.com/642002.html" target="_blank" rel="noopener"
>Linux ä¸­ Sleep å’Œ Wait å‘½ä»¤çš„ä½¿ç”¨æ–¹å¼&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://linuxdiary.blogspot.com/2007/10/blog-post_30.html" target="_blank" rel="noopener"
>LINUX å­¸ç¿’æ—¥èªŒ - æŠŠå‘½ä»¤æ”¾åˆ°èƒŒæ™¯åŸ·è¡Œ&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://unix.stackexchange.com/questions/352781/background-zombie-daemon-and-without-ctty-are-these-concepts-connected" target="_blank" rel="noopener"
>Background, zombie, daemon and without ctty - are these concepts connected?&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://stackoverflow.com/questions/3004811/how-do-you-run-multiple-programs-in-parallel-from-a-bash-script" target="_blank" rel="noopener"
>How do you run multiple programs in parallel from a bash script?&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://man7.org/linux/man-pages/man1/time.1.html#OPTIONS" target="_blank" rel="noopener"
>time(1) â€” Linux manual page&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://man7.org/linux/man-pages/man2/waitpid.2.html" target="_blank" rel="noopener"
>wait(2) â€” Linux manual page&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://docs.docker.com/engine/reference/commandline/attach/" target="_blank" rel="noopener"
>docker attach&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://hackmd.io/@owlfox/SyaTF2VgL/https%3A%2F%2Fhackmd.io%2Fs%2FSkh_AaVix" target="_blank" rel="noopener"
>Concurrency ç¨‹å¼è¨­è¨ˆ - HackMD&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>